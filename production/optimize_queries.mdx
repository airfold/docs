---
title: 'Optimize Queries'
description: "Optimizing queries with materialized pipes"
icon: 'magnifying-glass'
---

Optimizing queries is a crucial part of managing production workloads in Airfold, specifically by precomputing and storing results incrementally through **materialized pipes**.

## What are Materialized Pipes?

Materialized pipes **precompute** and **store results** as data is ingested. They offer a more efficient way to handle repetitive or resource-intensive queries compared to draft or published pipes.

**How they work**:
- **Incremental Processing**: Materialized pipes compute results as new data flows in, maintaining up-to-date outputs without reprocessing the entire dataset
- **Precomputed Results**: Instead of executing a query from scratch every time, results are precomputed and stored in a target source
- **Fast Queries**: Precomputed results are served instantly, avoiding recomputation

## Use Cases

**Frequent Queries**:
- Ideal for scenarios where the same query is executed repeatedly, such as dashboards or real-time Monitoring

**Recent Data Analysis**:
- Perfect for use cases where the focus is on recently ingested data
- Materialized pipes maintain results incrementally as new data arrives

## Caveats

**Immutable Results**:
- Once data is materialized, you cannot change how the results were computed
- Any change in logic requires creating a new materialized pipe

**No Retroactive Updates**:
- Materialized pipes work with newly ingested data and cannot retroactively apply changes to older data
- This makes them unsuitable for scenarios where historical recalculations are needed

## Draft to Materialized Pipe

### Define a Draft Pipe

Start by creating a draft pipe to develop and test your pipeline.

```yaml logs_aggregation.yaml
description: 'Aggregate logs by level'
nodes:
  - load:
      description: Load raw logs
      sql: select timestamp, level, file, message from logs
  - aggregate:
      description: Aggregate log counts by level
      sql: |
          select
              level,
              countState() as count
          from load
          group by level
to: logs_by_level
```

Push this draft pipe by running:

```
af push logs_aggregation.yaml
```

### Materialize the Draft Pipe

To materialize the pipe, run the `af pipe materialize` command:

```
af pipe materialize logs_aggregation.yaml
```

### Query Materialized Data
After materializing the pipe, the results are stored in the target source `logs_by_level`. 

You can query it directly by running:
```
af pipe query logs_by_level
```